<font face="Monaco">

# C++å®ç°çš„kvå°å‹MVCCæ•°æ®åº“

ä¸è€ƒè™‘æŒä¹…åŒ–å’Œå®¹é”™ï¼Œä»…ä¸ºåŠ æ·±å°è±¡ã€‚

## 0x00 preview

æ•°æ®åº“çš„äº‹åŠ¡å½“ç„¶å¯ä»¥ç›´æ¥é€šè¿‡åŠ é”æ¥å®ç°ï¼Œä¹Ÿå°±æ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œæ¯ä¸ªæ—¶åˆ»ï¼Œéƒ½åªæœ‰ä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚è¿™æ ·ï¼š

```C++
// å†…å­˜kvï¼ŒæŒä¹…åŒ–ä¸åœ¨æ­¤èŒƒå›´å†…
class KV {
public:
    string get(string key) {
        std::lock_guard lockGuard(mutex_);
        // TODO:...
    }
    
    void set(string key, string value) {
        std::lock_guard lockGuard(mutex_);
        // TODO:...
        // TODO: ä¸€äº›rollbackçš„æ–¹æ³•....
    }

private:
    std::map<string, string> data_;
    std::mutex mutex_;
};
```

åªè¦ä¸æ”¾å¼€é”ï¼Œå°±æ²¡æœ‰äººå¯ä»¥è®¿é—®åˆ°partial transcationï¼Œå®Œå…¨ç¬¦åˆè¦æ±‚ï¼Œä½†å…¶æ•ˆç‡å¯ä»¥è¯´æ˜¯éå¸¸éå¸¸çš„ä½ä¸‹ï¼Œä¸ºäº†å°½å¯èƒ½çš„æé«˜æ€§èƒ½ï¼Œè¿è¡Œæ›´å¤šçš„çº¿ç¨‹åŒæ—¶è®¿é—®æ•°æ®æ˜¯ä¸€ç§åŠæ³•ï¼Œä½†è¿™ä¹Ÿæ„å‘³ç€æ›´éš¾çš„é—®é¢˜å‡ºç°ã€‚


å®é™…ä¸Šï¼Œæ•°æ®åº“åœ¨æ‰§è¡Œäº‹åŠ¡çš„æ—¶å€™å¹¶ä¸äº†è§£higher-levelæƒ³è¦ä¼ è¾¾çš„ä¸œè¥¿ï¼Œå®ƒåªçŸ¥é“readå’Œwriteæ“ä½œè€Œå·²ï¼Œè€Œè¿™ç§æ“ä½œä¸­ï¼Œreadå’Œreadè‚¯å®šæ˜¯ä¸ä¼šå‡ºç°å†²çªçš„ï¼Œwriteå‘ç”Ÿçš„æ—¶å€™ï¼Œæœ‰è¿™ä¹ˆå‡ ç§å¯èƒ½ï¼š

* read-write
* write-read
* write-write

### RW

è¿™ç§æƒ…å†µç§°ä¸º __ä¸å¯é‡å¤è¯»__ ï¼Œæ¯”å¦‚T1å’ŒT2ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå¹¶ä¸”å®ƒä»¬äº¤æ›¿çš„æ‰§è¡Œ(å¹¶å‘)ï¼Œè¿™ç‚¹æœ‰ç‚¹åƒçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚

![](./mvcc_pic/ä¸å¯é‡å¤è¯».png)

T1ä¸€å¼€å§‹è·å¾—çš„æ•°æ®æ˜¯A=10ï¼Œè€ŒT2ä¿®æ”¹äº†A=19ï¼Œæœ€åï¼ŒT1äº‹åŠ¡ç»“æŸå‰ï¼Œåˆè¯»å–äº†ä¸€æ¬¡Aï¼Œå¾—åˆ°çš„æ˜¯A=19ï¼Œåœ¨T1æ•´ä¸ªäº‹åŠ¡ä¸­ï¼ŒAå‡ºç°äº†ä¸¤ç§ä¸åŒçš„å€¼ã€‚

å¦‚æœT1å’ŒT2æ˜¯ä¸²è¡ŒåŒ–çš„ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå‡ºç°è¿™ç§é—®é¢˜ã€‚

### WR

WRçš„æƒ…å†µç§°ä¸º __è„è¯»__ ï¼Œå‡è®¾æœ‰è¿™ä¹ˆ2ä¸ªäº‹åŠ¡ï¼ŒT1å’ŒT2ï¼Œå®ƒä»¬éƒ½åšåŒæ ·çš„ä¸€ä»¶äº‹ï¼šå°†Açš„å¸æˆ·â•2ğŸ’°ï¼Œé‚£ä¹ˆæ‰§è¡Œæƒ…å†µå¯èƒ½å¦‚ä¸‹: 

![](./mvcc_pic/è„è¯».png)

T1è¯»å–Aï¼Œå¹¶ä¸”â•2ğŸ’°åˆ°Aå¸æˆ·ä¸­ï¼Œä¹‹åï¼ŒT2å¼€å§‹ï¼ŒT2è¯»å–åˆ°äº†T1çš„å†™æ“ä½œï¼Œä½†å…¶å®T1äº‹åŠ¡è¿˜æœªç»“æŸï¼Œè¿™å±äºçœ‹åˆ°äº†partial transcationçš„ç»“æœï¼Œä¹‹åï¼ŒT2åšäº†ç›¸åŒçš„äº‹æƒ…ï¼ŒAçš„å¸æˆ·é‡‘é¢æ¥åˆ°äº†14ï¼Œä½†T1å‘ç”Ÿäº†ä¸€äº›é—®é¢˜ï¼ŒT1äº‹åŠ¡ç»ˆæ­¢äº†ï¼Œæœ€ç»ˆï¼ŒAçš„å¸æˆ·ä¸º14ï¼Œè¿™æ˜¾ç„¶æ˜¯é”™è¯¯çš„ç­”æ¡ˆã€‚

### WW

WWä¸º __å†™å†™å†²çª__ ï¼Œå³è¦†ç›–æœªæäº¤çš„æ•°æ®ã€‚

æ¯”å¦‚ï¼š

![](./mvcc_pic/å†™å†™å†²çª.png)

T1å’ŒT2éƒ½åœ¨æœªè¯»æ•°æ®çš„æƒ…å†µä¸‹ç›´æ¥å°±å¯¹Aå’ŒBè¿›è¡Œäº†å†™å…¥ï¼Œä»¥è¿™ä¸ªå›¾æ¥çœ‹ï¼Œæœ€ç»ˆç»“æœæ˜¾ç„¶ä¹Ÿæ˜¯é”™è¯¯çš„ï¼Œå› ä¸º19ğŸ’°å¹¶ä¸æ˜¯Bieberæ“ä½œçš„ã€‚


## 0x01 å¹¶å‘è°ƒåº¦

__å½“ä¸”ä»…å½“è¿™ä¸ªå¹¶å‘è°ƒåº¦ä¸‹æ‰€å¾—åˆ°çš„æ–°æ•°æ®åº“ç»“æœå’Œåˆ†åˆ«ä¸²è¡Œçš„è¿è¡Œè¿™äº›äº‹åŠ¡æ‰€å¾—åˆ°çš„æ–°æ•°æ®åº“ç»“æœå®Œå…¨ä¸€è‡´ï¼Œåˆ™è¯´è¿™ä¸ªè°ƒåº¦æ˜¯æ­£ç¡®çš„__ ã€‚

### å¯ä¸²è¡ŒåŒ–(Serializable)

å®šä¹‰ï¼šä¸ç®¡åˆå§‹æ—¶æ•°æ®åº“çš„çŠ¶æ€å¦‚ä½•ï¼Œä¸€ä¸ª __è°ƒåº¦å¯¹æ•°æ®åº“çŠ¶æ€çš„å½±å“__ å’Œ __æŸä¸ªä¸²è¡Œè°ƒåº¦__ `ç›¸åŒ`ï¼Œ é‚£ä¹ˆè¿™ä¸ªè°ƒåº¦å°±æ˜¯ __å¯ä¸²è¡ŒåŒ–çš„__ï¼Œæˆ–è€…è¯´æ˜¯ __å¯ä¸²è¡Œæ€§__ï¼Œè¿™ä¹Ÿæ„å‘³ç€è¿™ç§ __å¹¶å‘è°ƒåº¦__ æ˜¯æ­£ç¡®çš„ã€‚


// TODO:è¿™é‡Œåº”è¯¥æœ‰ä¸ªä¾‹å­andä¸€å¼ å›¾ã€‚


__å¯ä¸²è¡ŒåŒ–çš„è°ƒåº¦__ï¼Œä¸€å®šæ˜¯`æ­£ç¡®`çš„å¹¶è¡Œè°ƒåº¦ï¼Œ __ä¸è¿‡æœ‰äº›å¹¶è¡Œè°ƒåº¦ï¼Œå¯èƒ½ä¼šå¾—å‡ºæ­£ç¡®çš„ç»“æœ__ï¼Œä½†è¿™äº›å¹¶è¡Œè°ƒåº¦åŒæ ·æ˜¯`é”™è¯¯`çš„ã€‚


### å†²çªå¯ä¸²è¡Œæ€§(Conflict Serializable)

å®šä¹‰ï¼šä¸€ä¸ªè°ƒåº¦ï¼Œå¦‚æœé€šè¿‡ __äº¤æ¢ç›¸é‚»çš„ä¸¤ä¸ªæ— å†²çªçš„æ“ä½œ__ èƒ½å¤Ÿè½¬æ¢åˆ°æŸä¸€ä¸ªä¸²è¡Œçš„è°ƒåº¦ï¼Œé‚£ä¹ˆå°±ç§°è¿™ç§è°ƒåº¦ä¸ºå†²çªå¯ä¸²è¡ŒåŒ–è°ƒåº¦ã€‚

å…¶ä¸­ï¼Œå†²çªçš„æ“ä½œæœ‰ï¼š

> åŒä¸€ä¸ªäº‹åŠ¡å†…ï¼Œè°ƒæ•´æ“ä½œé¡ºåºã€‚è¿™æ˜¯è‚¯å®šä¸å…è®¸çš„ï¼Œä¼šå¯¼è‡´ä¸€äº›higher-levelå‡ºç°é—®é¢˜ã€‚
 
> ä¸åŒäº‹ç‰©ï¼Œè¯»å†™åŒä¸€ä¸ªå…ƒç´ ï¼Œéƒ½æ˜¯ä¸å…è®¸è¿›è¡Œè°ƒæ•´é¡ºåºçš„ï¼Œè¯»å†™ä¸åŒçš„å…ƒç´ åˆ™æ˜¯å…è®¸äº¤æ¢é¡ºåºã€‚

è¿™é‡Œçš„Conflict Serializableæ¯”ä¹‹å‰çš„Serializableçš„æ¦‚å¿µæ›´ä¸ºä¸¥æ ¼ï¼Œä¸¤è€…è™½ç„¶éƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯å¯èƒ½å­˜åœ¨Serializableï¼Œä½†æ˜¯å´ä¸ç¬¦åˆConflict Serializableï¼Œè€Œç›¸åï¼Œç¬¦åˆConflict Serializableä¸€å®šç¬¦åˆSerializableã€‚

## 0x02 2PL(two-Phase Locking)

äºŒé˜¶æ®µé”ç®—æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„äº‹åŠ¡å®ç°æ–¹å¼äº†ï¼Œå³æœ‰2ä¸ªé˜¶æ®µï¼Œè·å–é”é˜¶æ®µå’Œé‡Šæ”¾é”é˜¶æ®µï¼Œéšç€äº‹åŠ¡çš„è¿›è¡Œï¼Œæ¯ä¸ªäº‹åŠ¡æ‰€è·å–çš„é”ä¼šè¶Šæ¥è¶Šå¤šï¼Œç›´åˆ°Commitã€Abortæˆ–è€…Rollbackæ‰ä¼šé‡Šæ”¾æ‰€æœ‰å·²å¾—çš„é”ã€‚

2PLæ˜¯å®Œå…¨ç¬¦åˆä¸²è¡ŒåŒ–çš„ï¼Œåªä¸è¿‡ç¼ºç‚¹ä¹Ÿæ˜¯éå¸¸æ˜æ˜¾ï¼šäº‹åŠ¡ä¸€ç›´ä¸é‡Šæ”¾æ‰€è·å¾—çš„é”ï¼Œé‚£ä¹ˆå…¶ä»–äº‹åŠ¡å¦‚æœæƒ³è·å–åŒä¸€æŠŠé”ï¼Œé‚£ä¹ˆä¼šè¢«é•¿æ—¶é—´é˜»å¡ï¼Œè€Œä¸”ä¼šæœ‰æ­»é”é£é™©ï¼Œè™½ç„¶æ­»é”å¯ä»¥é€šè¿‡ä¸€äº›é¢„é˜²ç®—æ³•æˆ–è€…è¶…æ—¶æœºåˆ¶æ¥è§£å†³ï¼Œä½†2PLçš„æ•ˆç‡ç¡®å®ä¸èƒ½ç§°å¾—ä¸Šä¼˜ç§€ã€‚

## 0x03 MVCC with 2PL

åœ¨2PLä¸­å¼•å…¥MVCCçš„æœºåˆ¶ï¼Œä½¿å¾—RRï¼ŒRWï¼ŒWRä¸ä¼šè¢«é˜»å¡ï¼Œå¯ä»¥æœ‰æ•ˆçš„æé«˜äº‹åŠ¡å¹¶å‘çš„æ•ˆç‡ã€‚

MVCCçš„å®ç°æœ‰éå¸¸å¤šç§ï¼Œç½‘ä¸Šå…³äºMySQLç­‰å„ç§æ•°æ®åº“çš„åŸç†éƒ½å†™å¾—ä¸ä¸€ï¼Œè¿™é‡Œæˆ‘åªæŒ‰15-721ä¸­è®¨è®ºåˆ°çš„ä¸€ç§æ–¹å¼æ¥å®ç°ã€‚

é¦–å…ˆæ˜¯å„ç§å®ç°æ–¹å¼ï¼š

> MVCC with Timestamp (MVTO)

> MVCC with OCC (MVOCC)

> MVCC with 2PL (MV2PL)

å…¶ä¸­MV2PLä¹Ÿå°±æ˜¯æœ¬æ–‡å®ç°çš„æ–¹å¼ï¼Œå³åœ¨2PLä¸­å¼•å…¥å¤šç‰ˆæœ¬ï¼Œä½¿å¾—å†å²çš„æ•°æ®ç‰ˆæœ¬éƒ½å­˜åœ¨ï¼Œå¯¹æ­¤ï¼Œéœ€è¦å¼•å…¥ä¸€äº›æ–°çš„å­—æ®µæ¥é…åˆå®ç°ã€‚

![](./mvcc_pic/mv2pl1.png)

åˆ†åˆ«æ˜¯ï¼š

* TXN-ID å½“å‰åœ¨å†™çš„äº‹åŠ¡ID
* READ-CNT å½“å‰è¯»å–è¿™ä¸ªTupleçš„äº‹åŠ¡æ€»æ•°
* BEGIN-TS Tupleè¢«åˆ›å»º(æäº¤)æ—¶çš„äº‹åŠ¡ID
* END-TS Tupleå¤±æ•ˆçš„äº‹åŠ¡ID
* PTR æŒ‡å‘ä¸‹ä¸€ä¸ªTuple(å–å†³äºå®ç°æ–¹å¼)

å…¶ä¸­äº‹åŠ¡IDå¯ä»¥çœ‹ä½œä¸€ä¸ªæ—¶é—´è½´ï¼Œå¯ä»¥æ˜¯ç³»ç»ŸçœŸå®æ—¶é—´ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªé€’å¢çš„åºåˆ—ï¼ŒBEGIN-TSåˆ°END-TSæ„æˆäº†ä¸€ä¸ªç‰ˆæœ¬çš„â€œç”Ÿå‘½å‘¨æœŸâ€ã€‚

### shared lock

å½“ä¸€ä¸ªäº‹åŠ¡è¿›è¡Œè¯»å–Tupleçš„æ“ä½œæ—¶ï¼Œé¦–å…ˆä¼šè¿›è¡Œè¯»é”çš„æ“ä½œã€‚

![](./mvcc_pic/mv2pl2.png)

äº‹åŠ¡ä¼š __é¦–å…ˆè¿›è¡ŒTXN-IDçš„æ£€æŸ¥ï¼Œå¦‚æœä¸º0ï¼Œé‚£ä¹ˆå¯ä»¥è¿›è¡Œä¸Šé”__ï¼Œå³ï¼šå°†READ-CNT + 1è¡¨ç¤ºæœ‰ä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å½“å‰çš„Tupleã€‚

æ³¨ï¼šTXN-IDå’ŒREAD-CNTæ˜¯ä¸¤ä¸ªå­—æ®µï¼Œå¦‚æœéƒ½ä¸º64bitï¼Œå¹¶ä¸”éœ€è¦è¿›è¡ŒCASæ“ä½œçš„è¯ï¼Œç›®å‰x86æ— è¿™ç§æŒ‡ä»¤é›†ï¼Œæ‰€ä»¥å¯ä»¥ç¼©çŸ­ä¸º32bit(æš‚ä¸è€ƒè™‘è€—å°½)ï¼Œåˆæˆ–è€…å¯ä»¥ç”¨latchæ¥ä¿æŠ¤ï¼Œè¿™é‡Œçš„latchä¸æ˜¯äº‹åŠ¡ä¸­çš„â€œLOCKâ€ï¼Œä»…ä»…æ˜¯ä¸ºäº†ä¿æŠ¤å®ç°ç»“æ„è€Œå·²ï¼Œå½“ç„¶å®Œå…¨å¯ä»¥ä½¿ç”¨åŸå­å˜é‡ï¼Œå³ä½¿ä½¿ç”¨MVTOä¹Ÿ __ä¸ä»£è¡¨å®ç°MVTOçš„æ•°æ®ç»“æ„æ˜¯â€œlatch-freeâ€çš„__ã€‚

### exclusive lock

å½“ä¸€ä¸ªäº‹åŠ¡è¿›è¡Œå†™Tupleæ“ä½œæ—¶ï¼Œé¦–å…ˆéœ€è¦è·å–å†™é”æ“ä½œã€‚

![](./mvcc_pic/mv2pl3.png)
äº‹åŠ¡ä¼š __é¦–å…ˆè¿›è¡ŒTXN-IDå’ŒREAD-CNTçš„æ£€æŸ¥ï¼Œå¦‚æœéƒ½ä¸º0ï¼Œé‚£ä¹ˆå¯ä»¥è¿›è¡Œä¸Šé”__ï¼Œå³ï¼šå°†READ-CNT + 1ï¼Œå¹¶ä¸”å°†TXN-IDæ”¹å†™ä¸ºå½“å‰çš„äº‹åŠ¡IDï¼Œè¡¨ç¤ºæœ‰äº‹åŠ¡è¿›è¡Œä¿®æ”¹å½“å‰Tupleã€‚

### å­˜å‚¨æ–¹å¼

æœ¬æ–‡å®ç°çš„ç‰ˆæœ¬å­˜å‚¨æ–¹å¼ä¸ºAPPEND ONLY çš„ O2Nï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰è®¸å¤šç§å®ç°æ–¹å¼:

> APPEND ONLY N2O

> DELTA

> TIME TRAVEL

APPEND ONLY O2Nçš„ç»“æ„å›¾ï¼š

![](./mvcc_pic/mv2pl4.png)

### READ OPERATION

è¯»æ“ä½œï¼š

```C++
// å½“å‰äº‹åŠ¡IDï¼šC_ID
xxxxx read(KeyType key) {
    for ( version : ALLVersion ) {
        if ( version.BEGIN_TS <= C_ID < version.END_TS) {
            shared_lock(version);
            // do operation
            // add to ReadSet
            return version.Value;
        }
    }
    return SOME_ERROR;
}
```

### WRITE OPERATION

å†™æ“ä½œ:

```C++
// å½“å‰äº‹åŠ¡ID: C_ID
xxxxx write(KeyType key, ValueType value) {
    for ( version : ALLVersion ) {
        if ( versoin.END_TS == INF ) {
            exclusive_lock(version);
            // make new Version: version+1
            // do operation
            // add version to WriteSet
        }
    }
    return SOME_ERROR;
}
```

### COMMIT OPERATION

```C++
xxxxx commit() {
    uint64_t commitID = getTransactionID();
    for ( write : WriteSet ) {
        // set (version+1).BEGIN_TS = commitID
        // set (verion+1).END_TS = INF
        // set (version).END_TS = commitID
        exclusive_unlock(write)
    }
    for ( read : readSet ) {
        shared_unlock(read)
    }
}
```

### ABORT OPERATION

```C++
xxxxx abort() {
    for ( write: WriteSet ) {
        // delete (version + 1)
        exclusive_unlock(write);
    }
    for ( read : readSet ) {
        shared_unlock(read)
    }
}
```

## 0x04 IMPL

// TODO

## REF

[https://marsishandsome.github.io/2019/06/Multi_Version_Concurrency_Control](https://marsishandsome.github.io/2019/06/Multi_Version_Concurrency_Control)

[https://15445.courses.cs.cmu.edu/fall2021/](https://15445.courses.cs.cmu.edu/fall2021/)

[https://15721.courses.cs.cmu.edu/spring2020/](https://15721.courses.cs.cmu.edu/spring2020/)

[https://github.com/oceanwavechina/DotDB/blob/5a64cde5597acbdde6876e3bd00dbc8c8ae549c4/docs/%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E7%9A%84%E7%9B%B8%E5%85%B3%E7%AE%97%E6%B3%95.md](https://github.com/oceanwavechina/DotDB/blob/5a64cde5597acbdde6876e3bd00dbc8c8ae549c4/docs/%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E7%9A%84%E7%9B%B8%E5%85%B3%E7%AE%97%E6%B3%95.md)

</font>