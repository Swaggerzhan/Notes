# TCP/IP协议exp

### 1. IP协议

__IP协议提供一种尽力而为的服务，它无法保证数据包一定会到对端，当发生某些错误时，IP数据包可能会被丢弃__ 。关于IP数据报的发送和接收方式，它总是从最高有效位开始发送 __(一个32位的值总是先将0~7bit发出，然后才是8~15bit....)__ 。如此的字节顺序称为 __网络字节序__ ，计算机所使用的字节序(大端与小端)有所不同，需要时需进行转换。
![](./tcp_pic/1.png)

__0~3 bit__ `总共4bit`: __版本字段__ ，表示IP数据报的版本，一般为4和6，分别表示IPv4和IPv6。

__4~7 bit__ `总共4bit`: __IHL字段__ ，表示整个IP报头部字段的长度称为`IHL(Internet Header Length)`，由于只有4位，能表示最大值为15，其中每个`"1"对应一个32bit的大小`，也就是IP数据报头部被限制为最大值`15 * 32bit = 60bytes`。不过一般的IP数据包中都是`20bytes`，也就是将IHL设置为5。

__8~13 bit__ `总共6bit`: __DS字段__

__14~15 bit__ `总共2bit`: __ECN字段__

__16~31 bit__ `总共16bit`: __总长度字段__ ， __包括头部和数据部分__ ，我们可以配合IHL来判断`数据载荷`是从`IP数据报`的哪个地方开始的。由于它是一个16bit的字段，即能表示的最大值长度(包括头部)65535字节。即使如此，大多数的主机并不接受大于576字节的IPv4数据报(很多UDP协议都将自己的数据量限制为512字节大小，以免被抛弃)。要解决如此，需要将大的数据报分割成小的IP数据报发送(被分割的每个数据报本身还是相互独立)，其中片偏移字段就起到了作用。

__32~47 bit__ `总共16bit`: __标识字段__ ，留空。

__48~50 bit__ `总共3bit`: __标志字段__

__51~63 bit__ `总共13bit`: __分片偏移__

__64~71 bit__ `总共8bit`: __生存期字段__ TTL(time-to-live)表示的当前的IP数据报能经过的最大路由器数量，等同于IPv6中的最大跳，能够避免一些数据报在网络中出现循环跳的现象。一般将其设置为64或者128，少有的主机会将其设为255。当数据报被减少到0时，处理它的路由器会将数据报丢弃，并生成一个ICMP报告之发送着发生了什么。TTL影响到了整个头部字段的数据，每经过一个路由器都需要将头部效验和重新计算。

__72~79 bit__ `总共8bit`: __协议字段__ ，用于表明其IP数据报携带的上层协议是什么一般为17(UDP)和6(TCP)。

__80~95 bit__ `总共16bit`: __头部效验和字段__ ，此字段只效验IPv4头部是否发生了错误。IP数据报不保证其携带载荷的正确性，它由其上层协议自行验证。

__96~127 bit__ `总共32bit`: __源IP地址__ 。

__128~159 bit__  `总共32bit`: __目的IP地址__ 。

__160~最大479 bit__ 后续为可选字段，最多40字节。

### 2. TCP协议

TCP协议提供一种稳定的连接。
![](./tcp_pic/2.png)

下面直接分析其头部字段。

__0~15 bit__ `总共16bit`: __源端口__ 。

__16~31 bit__ `总共16bit`: __目的端口__ 。

__32~47 bit__ `总共32bit`: __序列号字段(seq)__ 。

__48~63 bit__ `总共32bit`: __确认号字段(ack)__ ，此字段配合ACK标志位，当ACK标志位设置为0时忽略，当ACK为1时启用。 __ACK表示一种“确认”，但我更愿称之为“请求”__ ，当对端发送一个`seq=x`的序列号时，本机回复`ack=x+1`，它表示 __“我已经成功接收到了你发送的数据”__ ，此外，还包含着 __“我希望你继续发送，发送的序列号请从x+1开始”__ 的请求。

__64~67 bit__ `总共4bit`: __头部长度__ ，同IP的IHL字段。

__68~71 bit__ `总共4bit`: __保留__ 。

__72~79 bit__ `总共8bit`: __这里将其总8个字段一起解释，每个字段占 1 bit__ 。
        
* CWR 即 __拥塞窗口减(Congestion Window Reduced)__ ，


* ECE 即 __ECN回显__ 


* URG


* ACK


* PSH


* RST


* SYN


* FIN
